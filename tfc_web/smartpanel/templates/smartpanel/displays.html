{% extends "smartpanel/base.html" %}
{% load static %}
{% block head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="{% static 'map.css' %}" />
{% endblock %}
{% block content %}
    <h1 class="mdl-typography--display-1-color-contrast" style="margin-top: 0;">My Displays</h1>
    <p>Displays are the actual Devices that will show your chosen layout.</p>
    <div style="height: 70vh;">
        <div id="map" style="height: 100%; width: 100%;"></div>
    </div>
    <dialog id="dialog-delete" class="mdl-dialog">
        <div class="mdl-dialog__content">
            <p>
                Are you sure you want to delete this display?
            </p>
        </div>
        <div class="mdl-dialog__actions mdl-dialog__actions--full-width">
            <form id="form_delete_display" action="" method="post">
                {% csrf_token %}
                <input type="submit" class="mdl-button mdl-js-button mdl-js-ripple-effect" value="Yes">
                <button type="button" class="mdl-button mdl-js-button mdl-js-ripple-effect close">No</button>
            </form>
        </div>
    </dialog>
    <script>
        var map = L.map('map').setView({{ mapcenter|default:"[52.205, 0.119], 13" }});
        var info_map = L.control();
        var displays = [{% for display in displays %}
            {
                "display_url": "{% url 'smartpanel-display' display.slug %}", "layout_name": "{{ display.layout.name }}",
                "layout_url": "{% url 'smartpanel-layout' display.layout.slug %}",
                "lat": "{{ display.location.y }}", "lon": "{{ display.location.x }}", "name": "{{ display.name }}",
                "edit_url": "{% url 'smartpanel-edit-display' display.slug %}",
                "delete_url": "{% url 'smartpanel-delete-display' display.slug %}"
            },
        {% endfor %}];

        info_map.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'leaflet-control-attribution leaflet-control'); // create a div with a class "info"
            return this._div;
        };

        $(document).ready(function() {
            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            info_map.addTo(map);
            for (var i = 0; i < displays.length; i++) {
                displays[i]['marker'] = L.marker([displays[i]['lat'], displays[i]['lon']]);
                displays[i]['marker'].addTo(map).bindTooltip(
                    "Display <a class=\"delete-link aqua-link\" href='"+displays[i]['display_url']+"'>"+
                    displays[i]['name']+"</a> using Layout <a class=\"delete-link aqua-link\" href='"+displays[i]['layout_url']+"'>"+
                    displays[i]['layout_name']+"</a><br>"+
                    "- <a class=\"edit-link aqua-link\" href='"+displays[i]['edit_url']+"'>Edit display " +
                    "<i class=\"material-icons\">chevron_right</i></a><br>" +
                    "- <a class=\"delete-link aqua-link\" data-display-delete-url='"+displays[i]['delete_url']+"'>\n" +
                    "Delete <i class=\"material-icons\" data-display-delete-url='"+displays[i]['delete_url']+"'>chevron_right</i></a>",
                    { permanent: true, interactive: true });
            }
            var dialog_delete = document.querySelector('#dialog-delete');
            var deleteModalButtons = document.querySelectorAll('.delete-link');
            if (! dialog_delete.showModal) {
                dialogPolyfill.registerDialog(dialog_delete);
            }
            for (var i = 0; i < deleteModalButtons.length; i++) {
                deleteModalButtons[i].addEventListener('click', function(event) {
                    dialog_delete.showModal();
                    document.querySelector('#form_delete_display').action = event.target.dataset.displayDeleteUrl;
                });
            }
            dialog_delete.querySelector('.close').addEventListener('click', function() {
                dialog_delete.close();
            });
        });
    </script>
{% endblock %}
