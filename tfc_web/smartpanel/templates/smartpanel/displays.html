{% extends "smartpanel/base.html" %}
{% load static %}
{% block head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="{% static 'map.css' %}" />
{% endblock %}
{% block content %}
    <div style="height: 80vh;">
        <div id="map" style="height: 100%; width: 100%;"></div>
    </div>
    <script>
        var map = L.map('map').setView({{ mapcenter|default:"[52.205, 0.119], 13" }});
        var info_map = L.control();
        var displays = [{% for display in displays %}
            { "display_url": "{% url 'smartpanel-display' display.id %}", "layout_name": "{{ display.layout.name }}",
                "layout_url": "{% url 'smartpanel-layout' display.layout.id %}",
                "lat": "{{ display.location.y }}", "lon": "{{ display.location.x }}", "name": "{{ display.name }}",
                "edit_url": "{% url 'smartpanel-edit-display' display.id %}"},
        {% endfor %}];

        info_map.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'leaflet-control-attribution leaflet-control'); // create a div with a class "info"
            return this._div;
        };

        $(document).ready(function() {
            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            info_map.addTo(map);
            for (var i = 0; i < displays.length; i++) {
                displays[i]['marker'] = L.marker([displays[i]['lat'], displays[i]['lon']]);
                displays[i]['marker'].addTo(map).bindTooltip(
                    "<a target='_blank' href='"+displays[i]['display_url']+"'>"+
                    displays[i]['name']+"</a><br> - <a target='_blank' href='"+displays[i]['layout_url']+"'>Layout "+
                    displays[i]['layout_name']+"</a>"+
                    "<br> - <a target='_blank' href='"+displays[i]['edit_url']+"'>Edit display</a>",
                    { permanent: true, interactive: true });
            }
        });
    </script>
{% endblock %}
