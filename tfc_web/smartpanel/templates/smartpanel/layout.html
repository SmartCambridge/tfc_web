{% load static %}
{% load remove_underscore %}
{% load jsonify %}
<!DOCTYPE html>

<html>

<head>

    <title>SmartCambridge SmartPanel</title>
    <link rel="stylesheet" href="{% static 'smartpanel/layout.css' %}"/>
    <link rel="stylesheet" href="{% static 'smartpanel/widgets.css' %}"/>
    <link rel="stylesheet" href="{% static 'smartpanel/widget_config.css' %}"/>
    {% for stylesheet in external_stylesheets %}
        <link rel="stylesheet" href="{{ stylesheet.href }}"{% if stylesheet.integrity %} integrity="{{ stylesheet.integrity }}"  crossorigin="anonymous"{% endif %}/>
    {% endfor %}
    {% for stylesheet in stylesheets %}
        <link rel="stylesheet" href="{{ stylesheet }}"/>
    {% endfor %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js" integrity="sha256-KWJavOowudybFMUCd547Wvd/u8vUg/2g0uSWYU5Ae+w=" crossorigin="anonymous"></script>
    <script src="{% static 'js/rtmonitor_api.js' %}"></script>
    <script src="{% static 'smartpanel/widget_config.js' %}"></script>
    {% for script in external_scripts %}
        <script src="{{ script.src }}"{% if script.integrity %} integrity="{{ script.integrity }}"  crossorigin="anonymous"{% endif %}></script>
    {% endfor %}
    {% for script in scripts %}
        <script src="{{ script }}"></script>
    {% endfor %}

</head>

<body class="layout">

    <div class="logos" style="height: 60px; width: {{display_width|default:"1920px"}}">
        <div id="screen_clock" class="screen_clock"></div>
        <a href="http://www.connectingcambridgeshire.co.uk/smartcamb/"><img alt="Connecting Cambridgshire" src="{% static 'images/logo_sc_112.png' %}"></a>
        <a href="http://www.cam.ac.uk"><img alt="The University of Cambridge" src="{% static 'images/logo_uc_112.png' %}"></a>
        <a href="https://www.greatercambridge.org.uk/"><img alt="Greater Cambridge Partnership" src="{% static 'images/logo_gcp_112.png' %}"></a>
        <span>SmartPanel</span>
    </div>

    <div class="grid_container" style="height: calc(({{display_width|default:"1920px"}} * 0.5625) - 60px); width: {{display_width|default:"1920px"}}">
        <div class="grid">
            {% for key, value in confdata.items %}
                <div class="grid-item" style="height: calc({{ value.design.h }}*100%/4);
                        width: calc({{ value.design.w }}*100%/6); top: calc({{ value.design.y }}*100%/4);
                        left: calc({{ value.design.x }}*100%/6);">
                    <div id="widget-{{ key }}" class="widget {{ value.configuration.widget }}">
                        {% if not value.configuration %}unconfigured{% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <script>
        // Note we must instatiate RTMonitorAPI before widgets
        var RTMONITOR_API = new RTMonitorAPI();
        // Widget spec requires a DEBUG global
        var DEBUG = '';
        var widget = [];
        {% for key, value in confdata.items %}
            {% if value.configuration %}
                {% with 'smartpanel/widgets/'|add:value.configuration.widget|add:'/' as widget_location %}
                    widget.push(new {{ value.configuration.widget|title|remove_underscore }}(
                        {'container': 'widget-{{ key }}', 'static_url': '{% static widget_location %}'},
                        JSON.parse("{{ value.configuration.data|jsonify|escapejs }}")
                    ));
                {% endwith %}
            {% endif %}
        {% endfor %}

        function reload_widgets () {
            for (var i = 0; i < widget.length; i++)
                if ('reload' in widget[i])
                    widget[i].reload();
        }

        function update_screen_clock() {
            var datetime = new Date();
            var hh = ('0'+datetime.getHours()).slice(-2);
            var mm = ('0'+datetime.getMinutes()).slice(-2);
            var ss = ('0'+datetime.getSeconds()).slice(-2);
            document.getElementById('screen_clock').innerHTML = hh+':'+mm+':'+ss;
        }

        {% if display %}
        function refresh_display() {
            $.ajax({
                type: "GET",
                url: '{% url 'smartpanel-display-refresh' display.id display.layout.id display.layout.version %}',
                success: function(data) {
                    console.log(data);
                    if (data['refresh'] === true) {
                        window.location.reload();
                    }
                },
            });
        }
        {% endif %}

        $().ready(function () {
            setInterval(update_screen_clock, 1000);
            for (var i = 0; i < widget.length; i++)
                if ('init' in widget[i])
                    widget[i].init();
            // Now we know widgets have run 'init', we can tell RTMonitorAPI to connect and tell those widgets
            RTMONITOR_API.init();
            setInterval(reload_widgets, 60000);
            {% if display %}
            setInterval(refresh_display, 60000);
            {% endif %}
        });
    </script>

</body>

</html>
