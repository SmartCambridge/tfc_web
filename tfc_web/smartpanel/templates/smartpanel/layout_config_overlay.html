{% load static %}
{% load jsonify %}
{% load remove_underscore %}
<!DOCTYPE html>
<html>
<head>
    <title>SmartCambridge SmartPanel</title>

    <!-- Material Design -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.teal-green.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <!-- Material Design -->

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

    <!-- BRUTSIN dependencies -->
    <link rel="stylesheet" href='https://cdn.jsdelivr.net/gh/brutusin/json-forms@1.6.3/dist/css/brutusin-json-forms.min.css'/>
    <link rel="stylesheet" href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'/>
    <script src="{% static 'smartpanel/brutusin-json-forms.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/gh/brutusin/json-forms@1.6.3/dist/js/brutusin-json-forms-bootstrap.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- BRUTSIN dependencies -->

    <link rel="stylesheet" href="{% static 'smartpanel/smartpanel.css' %}"/>
    <link rel="stylesheet" href="{% static 'smartpanel/widgets.css' %}"/>
    {% for stylesheet in external_stylesheets %}
        <link rel="stylesheet" href="{{ stylesheet.href }}"{% if stylesheet.integrity %} integrity="{{ stylesheet.integrity }}"  crossorigin="anonymous"{% endif %}>
    {% endfor %}
    {% for stylesheet in stylesheets %}
        <link rel="stylesheet" href="{{ stylesheet }}">
    {% endfor %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js" integrity="sha256-KWJavOowudybFMUCd547Wvd/u8vUg/2g0uSWYU5Ae+w=" crossorigin="anonymous"></script>
    <script src="{% static 'js/rtmonitor_api.js' %}"></script>
    {% for script in external_scripts %}
        <script src="{{ script.src }}"{% if script.integrity %} integrity="{{ script.integrity }}"  crossorigin="anonymous"{% endif %}></script>
    {% endfor %}
    {% for script in scripts %}
        <script src="{{ script }}"></script>
    {% endfor %}
</head>
<body>
    <div class="logos" style="height: 60px;">
        <form action="{% url 'smartpanel-layout-config' layout.id %}" method="post" id="config-form" style="float: left; margin-top: 10px; margin-left: 10px;">
            {% csrf_token %}
            <input type="hidden" name="data" id="form-data">
            <input class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored" type="submit" value="Save configuration" id="submit-form-data">
        </form>
        <form action="{% url 'smartpanel-layout-delete' layout.id %}" method="post" style="float: left; margin-top: 10px; margin-left: 10px;">
            {% csrf_token %}
            <input class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored" type="submit" value="Delete Design">
        </form>
        <form action="{% url 'smartpanel-layout-publish' layout.id %}" method="post" style="float: left; margin-top: 10px; margin-left: 10px;">
            {% csrf_token %}
            <input class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored" type="submit" value="Publish Layout">
        </form>
        <span style="font-size: 12px">Last published: {{ layout.version_date }}</span>
        <a href="http://www.connectingcambridgeshire.co.uk/smartcamb/"><img alt="Connecting Cambridgshire" src="{% static 'images/logo_sc_112.png' %}"></a>
        <a href="http://www.cam.ac.uk"><img alt="The University of Cambridge" src="{% static 'images/logo_uc_112.png' %}"></a>
    </div>
    <div class="grid-container mdl-color--teal-900" style="height: calc((100vw - 80px) * 0.5625); overflow: hidden;">
        <ul id="grid" class="grid">
            {% for key, value in confdata.items %}
                <li style="height: calc({{ value.design.h }}*100%/4);
                        width: calc({{ value.design.w }}*100%/6); top: calc({{ value.design.y }}*100%/4);
                        left: calc({{ value.design.x }}*100%/6);">
                    <div id="section-{{ key }}" style="height: 100%; width: 100%; background-color: white;">
                        {% if value.configuration %}
                            <div id="widget-{{ key }}" style="height: 90%; width: 100%; background-color: white;"></div>
                            <div style="height: 10%; width: 100%; background-color: white; margin: 0; padding: 0;">
                                <form action="{% url 'smartpanel-layout-delete-widget' layout.id %}" method="post" style="margin: 0; padding: 0; line-height: 1em;">
                                    {% csrf_token %}
                                    <input type="hidden" name="widgetid" value="{{ key }}">
                                    <input class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored" type="submit" value="Delete this widget">
                                </form>
                            </div>
                        {% else %}
                            <select id="widget-{{ key }}" class="widget mdl-textfield__input"
                                    style="width: 80%; top: 20px; position: relative; margin-bottom: 10px;">
                                <option value="" selected disabled>Select a widget</option>
                                {% for widget in widgets_list %}
                                <option value="{{ widget.file}}">{{ widget.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="container-form"></div>
                        {% endif %}
                    </div></li>
            {% endfor %}
        </ul>
    </div>
    <script>
        autogeneratedforms = {};
        $(".widget").change(function (e) {
            var widget_name = $(e.currentTarget).val();
            $.get('{% static 'smartpanel/widgets' %}/'+widget_name+'/'+widget_name+'_schema.json',
                function ( data ) {
                autogeneratedforms[e.currentTarget.id] = brutusin["json-forms"].create(data);
                $(e.currentTarget).next().empty();
                autogeneratedforms[e.currentTarget.id].render($(e.currentTarget).next()[0]);
            });
        });
        $('#config-form').submit(function (e) {
            var forms_valid = true;
            var data = {};
            Object.keys(autogeneratedforms).forEach(function(key) {
                if (autogeneratedforms[key].validate() === false) {
                    forms_valid = false;
                }
                data[key] = {};
                data[key]["widget"] = $('#'+key).val();
                data[key]["data"] = autogeneratedforms[key].getData();
            });
            if (forms_valid === false) {
                e.preventDefault();
            } else {
                $('#form-data').val(JSON.stringify(data));
            }
        });

        var widget = [];
        {% for key, value in confdata.items %}
            {% if value.configuration %}
            widget.push(new {{ value.configuration.widget|title|remove_underscore }}(
                {'container': 'widget-{{ key }}', 'static_url': '{% static 'smartpanel/widgets' %}/{{ value.configuration.widget }}/'},
                JSON.parse("{{ value.configuration.data|jsonify|escapejs }}")
            ));
            {% endif %}
        {% endfor %}

        $(document).ready(function () {
            for (var i = 0; i < widget.length; i++)
                if ('init' in widget[i])
                    widget[i].init();
        });
    </script>
</body>
</html>
